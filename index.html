<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Wagering Calculator & Journal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* (your original styles unchanged) */
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s, color 0.3s; }
        .table-cell { padding: 0.75rem; border: 1px solid #e5e7eb; text-align: center; }
        .header-cell { background-color: #f9fafb; font-weight: 600; }
        input[type="number"], input[type="text"], select, textarea { border-radius: 0.375rem; border: 1px solid #d1d5db; padding: 0.5rem; width: 100%; box-sizing: border-box; transition: background-color 0.3s, border-color 0.3s, color 0.3s; }
        .journal-input { text-align: left; padding-left: 0.5rem; }
        .lockout-red { color: #dc2626; font-weight: 700; }
        .profit-green { color: #16a34a; }
        .loss-red { color: #dc2626; }
        .disabled-row { background-color: #f3f4f6; opacity: 0.7; }
        #ratingScore { max-width: 100px; text-align: center; appearance: none; -webkit-appearance: none; -moz-appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 4 5'%3e%3cpath fill='%236b7280' d='M2 0L0 2h4zm0 5L0 3h4z'/%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 0.5rem center; background-size: 8px 10px; }
        /* Dark mode styles (unchanged) */
        body.dark-mode { background-color: #111827; color: #e5e7eb; }
        body.dark-mode .max-w-7xl { background-color: #1f2937; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.5), 0 2px 4px -2px rgba(0,0,0,0.5); }
        body.dark-mode h1, body.dark-mode h2, body.dark-mode h3 { color: #f3f4f6; }
        body.dark-mode .border-gray-200, body.dark-mode .border { border-color: #374151 !important; }
        body.dark-mode .bg-gray-50, body.dark-mode .bg-gray-100 { background-color: #374151 !important; border-color: #4b5563; }
        body.dark-mode .bg-white, body.dark-mode .bg-blue-50 { background-color: #4b5563 !important; }
        body.dark-mode .instruction-box { background-color: #1f2937 !important; border-color: #3b82f6 !important; color: #dbeafe !important; }
        body.dark-mode .table-cell { border-color: #4b5563; }
        body.dark-mode .header-cell { background-color: #374151; color: #f3f4f6; }
        body.dark-mode input[type="number"], body.dark-mode input[type="text"], body.dark-mode input[type="date"], body.dark-mode select, body.dark-mode textarea { background-color: #1f2937; color: #f3f4f6; border-color: #4b5563; }
        body.dark-mode .text-gray-700 { color: #d1d5db; }
        body.dark-mode .text-gray-800, body.dark-mode .text-gray-900 { color: #f3f4f6; }
        body.dark-mode .disabled-row { background-color: #1f2937; opacity: 0.5; }
        body.dark-mode #ratingScore { background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 4 5'%3e%3cpath fill='%23f3f4f6' d='M2 0L0 2h4zm0 5L0 3h4z'/%3e%3c/svg%3e"); }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
</head>
<body class="bg-gray-50 text-gray-800 p-4 sm:p-6 md:p-8">
    <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-md p-6">
        <header class="mb-6 pb-4 border-b border-gray-200 flex justify-between items-center">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Wagering Calculator & Journal</h1>
            <button id="darkModeToggle" onclick="toggleDarkMode()" class="p-2 rounded-full text-gray-500 hover:bg-gray-100 dark:text-gray-400 dark:hover:bg-gray-700 transition duration-150">
                <svg id="sunIcon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
                <svg id="moonIcon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>
            </button>
        </header>

        <div id="instructionsBox" class="mt-2 p-3 bg-blue-100 border border-blue-200 rounded-lg text-sm text-blue-900 instruction-box">
            <div id="instructionsHeader" class="font-semibold mb-1 cursor-pointer flex justify-between items-center" onclick="toggleInstructions()">
                <h2>How to Use This Tool:</h2>
                <span id="toggleArrow" class="transform transition-transform duration-300">‚ñº</span>
            </div>
            <div id="instructionsContent" class="hidden pt-2 border-t border-blue-200 mt-2">
                <ol class="list-decimal list-inside space-y-1">
                    <li><strong>Set Up Your Day:</strong> Enter your account and trade parameters in the boxes above.</li>
                    <li><strong>Log Trades:</strong> After each trade, enter the P/L and log a <strong>Screenshot Link</strong> and <strong>Notes</strong> in the log below.</li>
                    <li><strong>Complete Journal:</strong> At the end of the session, fill out the <strong>R.E.A.L.I.S.T. Journal</strong> questions at the bottom.</li>
                    <li><strong>Save:</strong> Press <strong>Save Current Session</strong> to save your data to your browser or <strong>Clear Log & Start New Day</strong> if you are starting a new day.</li>
                    <li><strong>Export Data:</strong> Click the <strong>Download buttons</strong> to save your saved Trade Log and separate Journal entries.</li>
                </ol>
            </div>
        </div>

        <div class="mt-6 p-4 bg-gray-100 rounded-lg border border-gray-200">
            <div class="mb-4">
                <label for="sessionDate" class="block text-sm font-semibold text-gray-700 mb-1">Today's Session Date:</label>
                <input type="date" id="sessionDate" class="w-full sm:w-1/3 mt-1" value="">
            </div>

            <div class="flex justify-start items-center flex-wrap gap-3 pt-2 border-t border-gray-300">
                 <button onclick="saveSession()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out text-sm">üíæ Save Current Session</button>
                 <button onclick="clearLogAndStartNewDay()" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out text-sm">‚ú® Clear Log & Start New Day</button>
                 <button onclick="clearAllSavedData()" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out text-sm">üóëÔ∏è Clear All Saved Data</button>
                <button id="downloadTradeLogButton" onclick="exportTradeLogToCSV()" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out text-sm">Download Trade Log (CSV)</button>
                <button id="downloadJournalButton" onclick="exportJournalToCSV()" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out text-sm">Download R.E.A.L.I.S.T. Journal (CSV)</button>
            </div>
        </div>

        <!-- (the rest of the HTML UI content is unchanged; kept for brevity in this snippet) -->
        <!-- ... account setup, trade setup, grid panels, trade log table, journal ... -->

        <div class="mt-8 pt-6 border-t">
             <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-4">Trade Log</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 border" id="tradeLogTable">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="table-cell header-cell w-16">Trade #</th>
                            <th class="table-cell header-cell">Recommended TP/SL ($)</th>
                            <th class="table-cell header-cell bg-blue-100">Actual Result ($)</th>
                            <th class="table-cell header-cell">Realized P&L ($)</th>
                            <th class="table-cell header-cell">Lockout</th>
                            <th class="table-cell header-cell bg-gray-100">Screenshot Link</th>
                            <th class="table-cell header-cell bg-gray-100">Notes / Rationale</th>
                        </tr>
                    </thead>
                    <tbody id="trade-rows" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>

        <hr class="mt-12 mb-6 border-gray-300">

        <!-- R.E.A.L.I.S.T. Journal (unchanged) -->
        <div class="mt-8 p-6 bg-gray-100 rounded-xl shadow-inner">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 flex items-center">THE R.E.A.L.I.S.T. JOURNAL üìù</h2>
            <div class="space-y-6">
                <!-- (journal sections: ratingScore, ratingReason, earningsNote, etc.) -->
                <div class="p-4 bg-white rounded-lg border border-gray-200">
                    <h3 class="font-semibold text-lg text-red-600 mb-2">R - Rate</h3>
                    <div class="flex items-center space-x-4 mb-3">
                        <label for="ratingScore" class="block text-sm font-medium text-gray-700">Rating (1 to 5):</label>
                        <select id="ratingScore" class="mt-1">
                            <option value="5">5 - Excellent</option>
                            <option value="4">4 - Good</option>
                            <option value="3" selected>3 - Average</option>
                            <option value="2">2 - Poor</option>
                            <option value="1">1 - Terrible</option>
                        </select>
                    </div>
                    <div>
                        <label for="ratingReason" class="block text-sm font-medium text-gray-700 mb-1">Why did you give it that score?</label>
                        <textarea id="ratingReason" rows="2" class="journal-input" placeholder="My score reflects my discipline and market read..."></textarea>
                    </div>
                </div>

                <!-- (other journal items remain unchanged) -->
                <div class="p-4 bg-white rounded-lg border border-gray-200">
                    <h3 class="font-semibold text-lg text-blue-600 mb-2">E - Earnings</h3>
                    <label for="earningsNote" class="block text-sm font-medium text-gray-700 mb-1">Were you profitable today? If not, what was the loss and why?</label>
                    <textarea id="earningsNote" rows="2" class="journal-input" placeholder="I was profitable by $175 and locked out according to the wagering strategy..."></textarea>
                </div>

                <div class="p-4 bg-white rounded-lg border border-gray-200">
                    <h3 class="font-semibold text-lg text-emerald-600 mb-2">A - Alignment</h3>
                    <label for="alignmentNote" class="block text-sm font-medium text-gray-700 mb-1">Did you follow your trading strategy today? If not, what caused you to go off-strategy?</label>
                    <textarea id="alignmentNote" rows="2" class="journal-input" placeholder="Yes, I stuck to my plan, or No, fear/greed caused me to..."></textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="p-4 bg-white rounded-lg border border-gray-200">
                        <h3 class="font-semibold text-lg text-amber-600 mb-2">L - Learning</h3>
                        <label for="learningNote" class="block text-sm font-medium text-gray-700 mb-1">What did you learn from the market, your behavior, or your decisions today?</label>
                        <textarea id="learningNote" rows="3" class="journal-input" placeholder="I do well when I walk away after each trade..."></textarea>
                    </div>
                    <div class="p-4 bg-white rounded-lg border border-gray-200">
                        <h3 class="font-semibold text-lg text-purple-600 mb-2">I - Improvements</h3>
                        <label for="improvementNote" class="block text-sm font-medium text-gray-700 mb-1">What could you have done better? How will you correct or prevent that?</label>
                        <textarea id="improvementNote" rows="3" class="journal-input" placeholder="I should have waited for confirmation. Next time, I will..."></textarea>
                    </div>
                </div>

                <div class="p-4 bg-white rounded-lg border border-gray-200">
                    <h3 class="font-semibold text-lg text-cyan-600 mb-2">S - Sorry</h3>
                    <label for="sorryNote" class="block text-sm font-medium text-gray-700 mb-1">Do you regret any trades? What would you change if you could redo it?</label>
                    <textarea id="sorryNote" rows="2" class="journal-input" placeholder="I regret Trade #4. It was a FOMO trade. Next time I will..."></textarea>
                </div>

                <div class="p-4 bg-white rounded-lg border border-gray-200">
                    <h3 class="font-semibold text-lg text-pink-600 mb-2">T - Trading Plan (Tomorrow)</h3>
                    <label for="tomorrowPlan" class="block text-sm font-medium text-gray-700 mb-1">What's your exact plan for tomorrow's trading? Be specific.</label>
                    <textarea id="tomorrowPlan" rows="3" class="journal-input" placeholder="I will only trade between 9:30-10:00 AM, while taking a break after every trade. I will also..."></textarea>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- DARK MODE LOGIC START ---
        function toggleDarkMode() {
            const body = document.body;
            const isDarkMode = body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', isDarkMode ? 'enabled' : 'disabled');
            updateToggleIcon(isDarkMode);
        }
        function updateToggleIcon(isDarkMode) {
            const sunIcon = document.getElementById('sunIcon');
            const moonIcon = document.getElementById('moonIcon');
            if (sunIcon && moonIcon) {
                sunIcon.classList.toggle('hidden', isDarkMode);
                moonIcon.classList.toggle('hidden', !isDarkMode);
            }
        }
        function loadDarkModePreference() {
            if (localStorage.getItem('darkMode') === 'enabled') {
                document.body.classList.add('dark-mode');
                updateToggleIcon(true);
            } else {
                updateToggleIcon(false);
            }
        }
        // --- DARK MODE LOGIC END ---

        const NUM_TRADES = 50;
        const INPUT_ELEMENT_IDS = [
            'currentBalance','maxLossLimit','lossLockoutPercent','tradeRange','autoLadder',
            'minProfitToKeep','lockInPercent','roundDown','feePerContract',
            'ratingScore','ratingReason','earningsNote','alignmentNote','learningNote',
            'improvementNote','sorryNote','tomorrowPlan','sessionDate'
        ];

        // -----------------------------
        // LOCAL STORAGE SHAPE & HELPERS
        // -----------------------------
        const STORAGE_KEY = 'tradingSessionData';

        function getSessionData() {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) {
                // Ensure default structure
                const base = {
                    // current visible log & settings
                    tradeLog: [],
                    // flattened, archived trades across days
                    tradeHistoryFlat: [],
                    // journal history array
                    realistHistory: [],
                    // arbitrary other keys for settings will be placed at top-level
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(base));
                return base;
            }
            try {
                const parsed = JSON.parse(raw);
                // Ensure arrays exist
                if (!Array.isArray(parsed.tradeLog)) parsed.tradeLog = [];
                if (!Array.isArray(parsed.tradeHistoryFlat)) parsed.tradeHistoryFlat = [];
                if (!Array.isArray(parsed.realistHistory)) parsed.realistHistory = [];
                return parsed;
            } catch (e) {
                console.error('Failed to parse session data, resetting:', e);
                const base = { tradeLog: [], tradeHistoryFlat: [], realistHistory: [] };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(base));
                return base;
            }
        }

        function setSessionData(obj) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(obj));
        }

        // Append current visible trades to tradeHistoryFlat with date stamp
        function appendCurrentTradesToHistory() {
            const sessionData = getSessionData();
            const sessionDate = document.getElementById('sessionDate').value || (new Date().toISOString().substring(0,10));
            for (let i = 1; i <= NUM_TRADES; i++) {
                const resultInput = document.getElementById(`result-${i}`);
                if (resultInput && resultInput.value.trim() !== '') {
                    const tradeObj = {
                        date: sessionDate,
                        tradeNumber: i,
                        result: resultInput.value,
                        screenshot: (document.getElementById(`screenshot-${i}`) || {}).value || '',
                        notes: (document.getElementById(`notes-${i}`) || {}).value || ''
                    };
                    sessionData.tradeHistoryFlat.push(tradeObj);
                }
            }
            setSessionData(sessionData);
        }

        // -----------------------------
        // SAVE / LOAD VISIBLE SESSION
        // -----------------------------
        function saveSession() {
            // load existing data
            const sessionData = getSessionData();
            // update settings & journal values (top-level keys)
            INPUT_ELEMENT_IDS.forEach(id => {
                const el = document.getElementById(id);
                if (el) sessionData[id] = el.value;
            });
            // save visible trade log
            const tradeLogData = [];
            for (let i = 1; i <= NUM_TRADES; i++) {
                const resultInput = document.getElementById(`result-${i}`);
                if (resultInput && resultInput.value.trim() !== '') {
                    tradeLogData.push({
                        tradeNumber: i,
                        result: resultInput.value,
                        screenshot: (document.getElementById(`screenshot-${i}`) || {}).value || '',
                        notes: (document.getElementById(`notes-${i}`) || {}).value || ''
                    });
                }
            }
            sessionData.tradeLog = tradeLogData;
            setSessionData(sessionData);
            alert("Session Saved! Visible trade log and settings stored locally.");
        }

        function loadSession() {
            const sessionData = getSessionData();
            // load settings & journal
            INPUT_ELEMENT_IDS.forEach(id => {
                const el = document.getElementById(id);
                if (el && sessionData[id] !== undefined) el.value = sessionData[id];
            });
            // default sessionDate if missing
            if (!sessionData.sessionDate || sessionData.sessionDate === '') {
                document.getElementById('sessionDate').value = new Date().toISOString().substring(0,10);
            }
            // load visible trade log (only current/latest)
            if (Array.isArray(sessionData.tradeLog)) {
                sessionData.tradeLog.forEach((trade, idx) => {
                    const i = trade.tradeNumber || (idx + 1);
                    if (document.getElementById(`result-${i}`)) {
                        document.getElementById(`result-${i}`).value = trade.result || '';
                        document.getElementById(`screenshot-${i}`).value = trade.screenshot || '';
                        document.getElementById(`notes-${i}`).value = trade.notes || '';
                    }
                });
            }
        }

        // -----------------------------
        // CLEAR / ARCHIVE BEHAVIOR
        // -----------------------------
        function clearLogAndStartNewDay() {
            const confirmClear = confirm("Are you sure you want to clear the on-screen Trade Log and R.E.A.L.I.S.T. Journal for a new day?\n\nThis will ARCHIVE the current visible trades into history, then clear the screen.");
            if (!confirmClear) return;

            // 1) Append visible trades to flat history
            appendCurrentTradesToHistory();

            // 2) Append the journal to realistHistory if not empty
            const sessionData = getSessionData();
            const currentSessionDate = (document.getElementById('sessionDate') || {}).value || new Date().toISOString().substring(0,10);
            const currentRealistEntry = {
                date: currentSessionDate,
                ratingScore: (document.getElementById('ratingScore') || {}).value || '',
                ratingReason: (document.getElementById('ratingReason') || {}).value || '',
                earningsNote: (document.getElementById('earningsNote') || {}).value || '',
                alignmentNote: (document.getElementById('alignmentNote') || {}).value || '',
                learningNote: (document.getElementById('learningNote') || {}).value || '',
                improvementNote: (document.getElementById('improvementNote') || {}).value || '',
                sorryNote: (document.getElementById('sorryNote') || {}).value || '',
                tomorrowPlan: (document.getElementById('tomorrowPlan') || {}).value || ''
            };
            // only push if there's meaningful content (not default)
            if (currentRealistEntry.ratingScore !== '3' || currentRealistEntry.ratingReason.trim() !== '' || currentRealistEntry.earningsNote.trim() !== '') {
                sessionData.realistHistory.push(currentRealistEntry);
            }

            // clear visible tradeLog (so screen is empty)
            sessionData.tradeLog = [];
            setSessionData(sessionData);

            // 3) Clear inputs on screen
            for (let i = 1; i <= NUM_TRADES; i++) {
                if (document.getElementById(`result-${i}`)) {
                    document.getElementById(`result-${i}`).value = '';
                    document.getElementById(`screenshot-${i}`).value = '';
                    document.getElementById(`notes-${i}`).value = '';
                }
            }
            // reset journal fields
            document.getElementById('ratingScore').value = '3';
            document.getElementById('ratingReason').value = '';
            document.getElementById('earningsNote').value = '';
            document.getElementById('alignmentNote').value = '';
            document.getElementById('learningNote').value = '';
            document.getElementById('improvementNote').value = '';
            document.getElementById('sorryNote').value = '';
            document.getElementById('tomorrowPlan').value = '';
            // set date to today
            document.getElementById('sessionDate').value = new Date().toISOString().substring(0,10);
            // recalc UI
            calculate();
            alert("New Trading Day Started. Today's trades were archived and are now available in the full export.");
        }

        function clearAllSavedData() {
            const confirmDelete = confirm("WARNING: This will permanently DELETE ALL saved historical trade data from your browser. Have you exported your data?\n\nClick OK to permanently delete the entire saved session history.");
            if (!confirmDelete) return;
            localStorage.removeItem(STORAGE_KEY);
            // clear visible screen as well
            for (let i = 1; i <= NUM_TRADES; i++) {
                if (document.getElementById(`result-${i}`)) {
                    document.getElementById(`result-${i}`).value = '';
                    document.getElementById(`screenshot-${i}`).value = '';
                    document.getElementById(`notes-${i}`).value = '';
                }
            }
            document.getElementById('sessionDate').value = new Date().toISOString().substring(0,10);
            // reset journal
            document.getElementById('ratingScore').value = '3';
            document.getElementById('ratingReason').value = '';
            document.getElementById('earningsNote').value = '';
            document.getElementById('alignmentNote').value = '';
            document.getElementById('learningNote').value = '';
            document.getElementById('improvementNote').value = '';
            document.getElementById('sorryNote').value = '';
            document.getElementById('tomorrowPlan').value = '';
            calculate();
            alert("All saved historical data has been permanently deleted. Your session is now empty.");
        }

        // -----------------------------
        // CSV Helper
        // -----------------------------
        function escapeForCSV(text) {
            if (text === undefined || text === null) return '';
            text = String(text);
            // double-quote escape
            text = text.replace(/"/g, '""');
            // wrap if contains comma, newline, or quote
            if (text.includes(',') || text.includes('\n') || text.includes('"')) {
                return `"${text}"`;
            }
            return text;
        }

        function downloadCSV(csvString, filename) {
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            } else {
                alert("Your browser does not support automatic downloads. Please copy the data manually.");
            }
        }

        // -----------------------------
        // EXPORT: Full flat trade history (plus visible unsaved trades)
        // -----------------------------
        function exportTradeLogToCSV() {
            const sessionData = getSessionData();
            const archived = Array.isArray(sessionData.tradeHistoryFlat) ? sessionData.tradeHistoryFlat : [];
            const sessionDate = (document.getElementById('sessionDate') || {}).value || new Date().toISOString().substring(0,10);

            // build CSV header
            const lines = [];
            lines.push('Date,Trade #,Actual Result ($),Screenshot Link,Notes / Rationale');

            // 1) archived trades (flat)
            archived.forEach(t => {
                const row = [
                    escapeForCSV(t.date || ''),
                    escapeForCSV(t.tradeNumber || ''),
                    escapeForCSV(t.result || ''),
                    escapeForCSV(t.screenshot || ''),
                    escapeForCSV(t.notes || '')
                ];
                lines.push(row.join(','));
            });

            // 2) include currently visible trades (they may not have been archived yet)
            for (let i = 1; i <= NUM_TRADES; i++) {
                const resultInput = document.getElementById(`result-${i}`);
                if (resultInput && resultInput.value.trim() !== '') {
                    const row = [
                        escapeForCSV(sessionDate),
                        escapeForCSV(i),
                        escapeForCSV(resultInput.value),
                        escapeForCSV((document.getElementById(`screenshot-${i}`) || {}).value || ''),
                        escapeForCSV((document.getElementById(`notes-${i}`) || {}).value || '')
                    ];
                    lines.push(row.join(','));
                }
            }

            if (lines.length === 1) { // only header
                alert("No trade entries found to export.");
                return;
            }

            const csvString = lines.join('\n');
            const filename = `ALL_Trades_${new Date().toISOString().substring(0,10).replace(/-/g,'')}.csv`;
            downloadCSV(csvString, filename);
            alert(`Exported ${lines.length - 1} trade rows (archived + visible).`);
        }

        // -----------------------------
        // EXPORT: R.E.A.L.I.S.T. journal (saved history)
        // -----------------------------
        function exportJournalToCSV() {
            const sessionData = getSessionData();
            const realistLog = Array.isArray(sessionData.realistHistory) ? sessionData.realistHistory : [];

            if (realistLog.length === 0) {
                alert("Saved R.E.A.L.I.S.T. journal history is empty. (Use 'Clear Log & Start New Day' to save today's journal to history).");
                return;
            }

            const lines = [];
            lines.push('Date,Rating,Rating Reason,Earnings Note,Alignment Note,Learning Note,Improvement Note,Sorry Note,Tomorrow Plan');

            realistLog.forEach(entry => {
                const ratingDescription = (document.getElementById('ratingScore')?.querySelector(`option[value="${entry.ratingScore}"]`)?.innerText) || '';
                const row = [
                    escapeForCSV(entry.date || ''),
                    escapeForCSV((entry.ratingScore || '') + (ratingDescription ? ' - ' + ratingDescription : '')),
                    escapeForCSV(entry.ratingReason || ''),
                    escapeForCSV(entry.earningsNote || ''),
                    escapeForCSV(entry.alignmentNote || ''),
                    escapeForCSV(entry.learningNote || ''),
                    escapeForCSV(entry.improvementNote || ''),
                    escapeForCSV(entry.sorryNote || ''),
                    escapeForCSV(entry.tomorrowPlan || '')
                ];
                lines.push(row.join(','));
            });

            const csvString = lines.join('\n');
            const filename = `REALIST_Journal_History_${new Date().toISOString().substring(0,10).replace(/-/g,'')}.csv`;
            downloadCSV(csvString, filename);
            alert(`Downloaded ${realistLog.length} saved R.E.A.L.I.S.T. entries.`);
        }

        // -----------------------------
        // CORE CALCULATION LOGIC (unchanged, preserved)
        // -----------------------------
        function getFloatValue(id) { return parseFloat(document.getElementById(id).value) || 0; }
        function getBoolValue(id) { return document.getElementById(id).value === 'true'; }

        function calculateContracts() {
            const dollarRiskText = document.getElementById('nextTradeSize').textContent;
            if (dollarRiskText === "LOCKED OUT") {
                document.getElementById('numContracts').textContent = "N/A";
                return;
            }
            const dollarRisk = parseFloat(dollarRiskText) || 0;
            const tradeRange = getFloatValue('tradeRange');
            const pointValue = 2;
            const riskPerContract = tradeRange * pointValue;
            let numContracts = 0;
            if (riskPerContract > 0) numContracts = Math.floor(dollarRisk / riskPerContract);
            document.getElementById('numContracts').textContent = numContracts;
        }

        function calculate() {
            const currentBalance = getFloatValue('currentBalance');
            const maxLossLimit = getFloatValue('maxLossLimit');
            const lossLockoutPercent = getFloatValue('lossLockoutPercent');
            const roundDown = getFloatValue('roundDown');
            const autoLadder = getBoolValue('autoLadder');
            const minProfitToKeep = getFloatValue('minProfitToKeep');
            const lockInPercent = getFloatValue('lockInPercent');
            const feePerContract = getFloatValue('feePerContract');

            const fullStack = currentBalance - maxLossLimit;
            const dailyLossLockout = fullStack * lossLockoutPercent;

            document.getElementById('fullStack').textContent = fullStack.toFixed(2);
            document.getElementById('dailyLossLockout').textContent = `-${dailyLossLockout.toFixed(2)}`;

            // Reset rows
            for (let j = 1; j <= NUM_TRADES; j++) {
                const rowEl = document.getElementById(`trade-row-${j}`);
                const resultEl = document.getElementById(`result-${j}`);
                if (rowEl) rowEl.classList.remove('disabled-row');
                if (resultEl) resultEl.disabled = false;
            }

            let runningPL = 0;
            let isLockedOut = false;
            let nextTradeSizeFound = false;

            for (let i = 1; i <= NUM_TRADES; i++) {
                const resultInput = document.getElementById(`result-${i}`);
                const recommendedTpslSpan = document.getElementById(`recommended-tpsl-${i}`);
                const runningPlSpan = document.getElementById(`running-pl-${i}`);
                const lockoutSpan = document.getElementById(`lockout-${i}`);
                const prevRunningPL = (i === 1) ? 0 : parseFloat(document.getElementById(`running-pl-${i - 1}`).textContent) || 0;

                let recommendedTpsl = 0;
                if (!isLockedOut) {
                    const tradeRange = getFloatValue('tradeRange');
                    const pointValue = 2;
                    const riskPerContract = tradeRange * pointValue;
                    let rawRisk = 0;
                    if (i === 1) {
                        rawRisk = dailyLossLockout * 0.5;
                    } else if (autoLadder && prevRunningPL > 0 && prevRunningPL >= minProfitToKeep) {
                        const profitToRisk = prevRunningPL - Math.max(minProfitToKeep, prevRunningPL * lockInPercent);
                        rawRisk = profitToRisk;
                    } else {
                        rawRisk = (dailyLossLockout + prevRunningPL) * 0.5;
                    }
                    let numContractsForFee = 0;
                    if (riskPerContract > 0) numContractsForFee = Math.floor(rawRisk / riskPerContract);
                    const totalFee = numContractsForFee * feePerContract * 2;
                    const finalRisk = rawRisk - totalFee;
                    recommendedTpsl = Math.floor(Math.max(0, finalRisk) / roundDown) * roundDown;
                }
                if (recommendedTpslSpan) recommendedTpslSpan.textContent = recommendedTpsl.toFixed(2);

                if (!isLockedOut && !nextTradeSizeFound) {
                    if (resultInput && resultInput.value.trim() === '') {
                       document.getElementById('nextTradeSize').textContent = recommendedTpsl.toFixed(2);
                       nextTradeSizeFound = true;
                    }
                }

                const actualResult = resultInput ? (parseFloat(resultInput.value) || 0) : 0;
                runningPL = prevRunningPL + actualResult;

                if (runningPlSpan) {
                    runningPlSpan.textContent = runningPL.toFixed(2);
                    runningPlSpan.classList.toggle('profit-green', runningPL > 0);
                    runningPlSpan.classList.toggle('loss-red', runningPL < 0);
                }

                let lockoutMsg = "";
                if (dailyLossLockout > 0 && runningPL <= -dailyLossLockout) {
                    lockoutMsg = "LOCKOUT (Daily Loss)";
                    isLockedOut = true;
                } else if (autoLadder && prevRunningPL > 0 && actualResult < 0 && prevRunningPL >= minProfitToKeep) {
                    lockoutMsg = "LOCKOUT (Ladder Loss)";
                    isLockedOut = true;
                }
                if (lockoutSpan) {
                    lockoutSpan.textContent = lockoutMsg;
                    lockoutSpan.classList.add('lockout-red');
                }

                if (isLockedOut) {
                    for (let j = i + 1; j <= NUM_TRADES; j++) {
                        const rowEl = document.getElementById(`trade-row-${j}`);
                        const resultEl = document.getElementById(`result-${j}`);
                        if (rowEl) rowEl.classList.add('disabled-row');
                        if (resultEl) resultEl.disabled = true;
                    }
                }
            }

            if (isLockedOut) {
                document.getElementById('nextTradeSize').textContent = "LOCKED OUT";
                document.getElementById('nextTradeSize').parentElement.classList.add('bg-red-600');
                document.getElementById('nextTradeSize').parentElement.classList.remove('bg-blue-600');
            } else {
                document.getElementById('nextTradeSize').parentElement.classList.remove('bg-red-600');
                document.getElementById('nextTradeSize').parentElement.classList.add('bg-blue-600');
                if (!nextTradeSizeFound) {
                    const lastRunningPL = parseFloat(document.getElementById(`running-pl-${NUM_TRADES}`).textContent) || 0;
                    const tradeRange = getFloatValue('tradeRange');
                    const pointValue = 2;
                    const riskPerContract = tradeRange * pointValue;
                    let rawRisk = 0;
                    if (autoLadder && lastRunningPL > 0 && lastRunningPL >= minProfitToKeep) {
                        const profitToRisk = lastRunningPL - Math.max(minProfitToKeep, lastRunningPL * lockInPercent);
                        rawRisk = profitToRisk;
                    } else {
                        rawRisk = (dailyLossLockout + lastRunningPL) * 0.5;
                    }
                    let numContractsForFee = 0;
                    if (riskPerContract > 0) numContractsForFee = Math.floor(rawRisk / riskPerContract);
                    const totalFee = numContractsForFee * feePerContract * 2;
                    const finalRisk = rawRisk - totalFee;
                    const finalTradeSize = Math.floor(Math.max(0, finalRisk) / roundDown) * roundDown;
                    document.getElementById('nextTradeSize').textContent = finalTradeSize.toFixed(2);
                }
            }
            calculateContracts();
        }

        // -----------------------------
        // BUILD TRADE ROWS
        // -----------------------------
        function createTradeRows() {
            const tbody = document.getElementById('trade-rows');
            for (let i = 1; i <= NUM_TRADES; i++) {
                const row = document.createElement('tr');
                row.id = `trade-row-${i}`;
                row.innerHTML = `
                    <td class="table-cell font-medium">${i}</td>
                    <td class="table-cell font-mono"><span id="recommended-tpsl-${i}">0.00</span></td>
                    <td class="table-cell bg-blue-50">
                        <input type="number" id="result-${i}" class="result-input font-mono" placeholder="0.00" step="0.01">
                    </td>
                    <td class="table-cell font-mono font-semibold"><span id="running-pl-${i}">0.00</span></td>
                    <td class="table-cell"><span id="lockout-${i}"></span></td>
                    <td class="table-cell">
                        <input type="text" id="screenshot-${i}" class="journal-input" placeholder="Paste link here..." maxlength="200">
                    </td>
                    <td class="table-cell">
                        <input type="text" id="notes-${i}" class="journal-input" placeholder="Market structure, setup type, etc..." maxlength="200">
                    </td>
                `;
                tbody.appendChild(row);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadDarkModePreference();
            createTradeRows();
            loadSession();
            calculate();
            // attach listeners
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => input.addEventListener('input', calculate));
        });
    </script>
</body>
</html>
